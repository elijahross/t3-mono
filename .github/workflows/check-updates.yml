name: Check Dependency Updates

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for updates
        id: check
        run: |
          echo "## Dependency Update Check" > update-report.md
          echo "" >> update-report.md
          echo "Generated: $(date -u)" >> update-report.md
          echo "" >> update-report.md

          check_pkg() {
            local pkg=$1
            local current=$2
            local latest=$(npm view "$pkg" version 2>/dev/null || echo "error")

            if [ "$latest" != "error" ] && [ "$current" != "$latest" ]; then
              echo "| $pkg | $current | $latest | âš ï¸ Update |" >> update-report.md
              echo "update_needed=true" >> $GITHUB_OUTPUT
            else
              echo "| $pkg | $current | $latest | âœ… |" >> update-report.md
            fi
          }

          echo "| Package | Current | Latest | Status |" >> update-report.md
          echo "|---------|---------|--------|--------|" >> update-report.md

          # Core
          check_pkg "next" "16.1.1"
          check_pkg "react" "19.0.0"
          check_pkg "typescript" "5.8.2"
          check_pkg "tailwindcss" "4.0.15"

          # Database & Auth
          check_pkg "@prisma/client" "7.2.0"
          check_pkg "next-auth" "4.24.13"
          check_pkg "@auth/prisma-adapter" "2.7.2"

          # tRPC
          check_pkg "@trpc/server" "11.0.0"
          check_pkg "@tanstack/react-query" "5.69.0"
          check_pkg "@t3-oss/env-nextjs" "0.13.10"

          # Testing
          check_pkg "vitest" "4.0.17"
          check_pkg "@testing-library/react" "16.3.0"

          # AI
          check_pkg "@langchain/core" "0.3.28"
          check_pkg "langchain" "0.3.7"

          # UI
          check_pkg "lucide-react" "0.562.0"
          check_pkg "recharts" "2.15.4"
          check_pkg "sonner" "2.0.7"

          # Restate
          check_pkg "@restatedev/restate-sdk" "1.9.1"

          cat update-report.md

      - name: Create issue if updates needed
        if: steps.check.outputs.update_needed == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ“¦ Dependency Updates Available"
          content-filepath: ./update-report.md
          labels: dependencies, maintenance
